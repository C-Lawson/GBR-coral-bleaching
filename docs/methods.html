<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="George Roff" />

<meta name="date" content="2024-03-29" />

<title>2024 mass coral bleaching event: methods</title>

<script src="site_libs/header-attrs-2.25/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/spacelab.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.2/css/all.min.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>






<link rel="stylesheet" href="bleaching.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">GBR bleaching analysis</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li>
  <a href="methods.html">
    <span class="fa fa-code"></span>
     
    Methods
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-gear"></span>
     
    Degree Heating Weeks analysis
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="timeseries.html">GBR-wide trajectories (1986:2024)</a>
    </li>
    <li>
      <a href="spatial-patterns.html">Spatial patterns of the 2024 event</a>
    </li>
    <li>
      <a href="spatial-patterns2.html">Spatial patterns of mass bleaching events</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://github.com/marine-ecologist/">
    <span class="fa fa-github"></span>
     
    GitHub
  </a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">2024 mass coral bleaching event:
methods</h1>
<h4 class="author">George Roff</h4>
<h4 class="date">2024-03-29</h4>

</div>


<p>Below is an intiial analysis of the DHW from the 2024 mass coral
bleaching event on the Great Barrier Reef.</p>
<div id="i-great-barrier-reef-shp-file" class="section level4">
<h4>i) Great Barrier Reef shp file</h4>
<p>First, load the GBRMPA shp files for the Great Barrier Reef. For
reproducibility the files are downloadable from <a
href="https://zenodo.org/records/5146061/preview/ymbozec/REEFMOD.6.4_GBR_HINDCAST_ANALYSES-v1.0.0.zip">Bozec
et al 2022</a>, and may differ from the official GBRMPA files available
from the GBRMPA <a
href="https://www2.gbrmpa.gov.au/geoportal/catalog/download/download.page">geoportal</a>.</p>
<pre class="r"><code>library(httr)
library(tidyverse)
library(janitor)
library(sf)
library(stars)
library(raster)
library(exactextractr)
library(tmap)
library(kableExtra)
library(reactable)
library(ggplot2)
library(terra)
library(tidyterra)

# write a function to get GBR shape file boundaries from eAtlas
get_gbr_shape &lt;- function(crs=&quot;EPSG:20353&quot;, source=&quot;file&quot;){

  if (source==&quot;url&quot;){
    #download from eAtlas
    url &lt;- &quot;https://nextcloud.eatlas.org.au/s/xQ8neGxxCbgWGSd/download/TS_AIMS_NESP_Torres_Strait_Features_V1b_with_GBR_Features.zip&quot;
    destfile &lt;- &quot;TS_AIMS_NESP_Torres_Strait_Features_V1b_with_GBR_Features.zip&quot;
    GET(url, write_disk(destfile, overwrite = TRUE))
    if (!dir.exists(&quot;unzipped_files&quot;)) {
      dir.create(&quot;unzipped_files&quot;)
    }
    unzip(&quot;TS_AIMS_NESP_Torres_Strait_Features_V1b_with_GBR_Features.zip&quot;, exdir = &quot;unzipped_files&quot;)
    shapefile_path &lt;- &quot;unzipped_files/TS_AIMS_NESP_Torres_Strait_Features_V1b_with_GBR_Features.shp&quot;
    
    gbr_shape &lt;- st_read(shapefile_path, quiet=TRUE) %&gt;%
      mutate(longitude = st_drop_geometry(.)$X_COORD,
             latitude = st_drop_geometry(.)$Y_COORD) |&gt;
      filter(FEAT_NAME==&quot;Reef&quot;) |&gt;
      st_set_crs(4283) |&gt;
      st_transform(20353) |&gt;
      st_make_valid() |&gt; 
      clean_names() |&gt; 
      dplyr::select(loc_name_s, qld_name, gbr_name, label_id, geometry, longitude, latitude) |&gt; 
      mutate(gbr_name = as.factor(gbr_name)) |&gt; 
      mutate(label_id = as.factor(label_id))
      
    zones &lt;- read.csv(&quot;/Users/rof011/GBR-coral-bleaching/data/gbr_zones.csv&quot;)
  
    gbr_shape_output &lt;- left_join(gbr_shape, zones, by=&quot;label_id&quot;)
  
    return(gbr_shape)
    
  } else if (source==&quot;file&quot;){
   #read from disk
   shapefile_path &lt;- &quot;/Users/rof011/GBR-coral-bleaching/data/Great_Barrier_Reef_Features.shp&quot;
  
    gbr_shape &lt;- st_read(shapefile_path, quiet=TRUE) %&gt;%
      mutate(longitude = st_drop_geometry(.)$X_COORD,
             latitude = st_drop_geometry(.)$Y_COORD) |&gt;
      filter(FEAT_NAME==&quot;Reef&quot;) |&gt;
      st_set_crs(4283) |&gt;
      st_transform(20353) |&gt;
      st_make_valid() |&gt; 
      clean_names() |&gt; 
      dplyr::select(loc_name_s, qld_name, gbr_name, label_id, geometry, longitude, latitude, 
             area_ha) |&gt; 
      mutate(gbr_name = as.factor(gbr_name)) |&gt; 
      mutate(label_id = as.factor(label_id))
      
    zones &lt;- read.csv(&quot;/Users/rof011/GBR-coral-bleaching/data/gbr_zones.csv&quot;)
  
    gbr_shape_output &lt;- left_join(gbr_shape, zones, by=&quot;label_id&quot;)
  
    return(gbr_shape)
  }

}


### note that sf throws topology errors:
# Error in scan(text = lst[[length(lst)]], quiet = TRUE) : 
#   scan() expected &#39;a real&#39;, got &#39;TopologyException:&#39;
# Error in (function (msg)  : 
#   TopologyException: CoverageUnion cannot process incorrectly noded inputs.
  

gbr_shape &lt;- get_gbr_shape(source=&quot;file&quot;) |&gt; 
  mutate(id=sub(&quot;([a-zA-Z])$&quot;, &quot;&quot;, label_id)) |&gt; # drop multi-named sub-reef ID
  group_by(gbr_name, id) |&gt; 
  summarise() |&gt; 
  st_make_valid() 

# get distinct label_ID for each reef without sub-headings
# complex as some reefs (e.g. U/N) are catch-all &quot;unknown reefs&quot;
gbr_shape_label_ID &lt;- get_gbr_shape() |&gt; 
  as_tibble() |&gt; 
  mutate(gbr_name=as.factor(gbr_name)) |&gt; 
  mutate(id=sub(&quot;([a-zA-Z])$&quot;, &quot;&quot;, label_id)) |&gt; 
  dplyr::select(gbr_name, id) |&gt;
  distinct(gbr_name,id)

### this approach seems to give the same approx reef area as the raw data:
gbr_shape_raw &lt;- get_gbr_shape() 
# gbr_shape |&gt; st_area() |&gt; sum()      # 28560112188 [m^2]
# gbr_shape_raw |&gt; st_area() |&gt; sum()  # 28560118763 [m^2]

 
  
head(gbr_shape) |&gt; kable(&quot;html&quot;) %&gt;% 
  kable_styling(&quot;striped&quot;, font_size=11) %&gt;% 
  scroll_box(width = &quot;100%&quot;)</code></pre>
<div
style="border: 1px solid #ddd; padding: 5px; overflow-x: scroll; width:100%; ">
<table class="table table-striped" style="font-size: 11px; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
gbr_name
</th>
<th style="text-align:left;">
id
</th>
<th style="text-align:left;">
geometry
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
(Big) Broadhurst Reef (No 1)
</td>
<td style="text-align:left;">
18-100
</td>
<td style="text-align:left;">
POLYGON ((1848551 7867941, …
</td>
</tr>
<tr>
<td style="text-align:left;">
(Big) Broadhurst Reef (No 2)
</td>
<td style="text-align:left;">
18-100
</td>
<td style="text-align:left;">
POLYGON ((1845249 7862813, …
</td>
</tr>
<tr>
<td style="text-align:left;">
(Big) Stevens Reef
</td>
<td style="text-align:left;">
20-295
</td>
<td style="text-align:left;">
POLYGON ((2094621 7653332, …
</td>
</tr>
<tr>
<td style="text-align:left;">
(Little) Broadhurst Reef
</td>
<td style="text-align:left;">
18-106
</td>
<td style="text-align:left;">
POLYGON ((1846710 7851185, …
</td>
</tr>
<tr>
<td style="text-align:left;">
(Little) Stevens Reef
</td>
<td style="text-align:left;">
20-294
</td>
<td style="text-align:left;">
POLYGON ((2085467 7656254, …
</td>
</tr>
<tr>
<td style="text-align:left;">
Abott Reef
</td>
<td style="text-align:left;">
19-222
</td>
<td style="text-align:left;">
POLYGON ((2119752 7720364, …
</td>
</tr>
</tbody>
</table>
</div>
<p>There are 3724 reefs, with seperate polygons for each reef label
identifier (e.g. U/N Reef has 09-361a through to 09-361f). Individual
polygons per reef ID were merged with <code>sf::union</code> to form
multipolygons (see example for U/N 20-299 reef which has 9 separate
label_id components).</p>
<pre class="r"><code>tmap_mode(&quot;plot&quot;)

a &lt;- tm_shape(gbr_shape_raw |&gt; filter(grepl(&quot;20-299&quot;, label_id))) + 
  tm_polygons(&quot;loc_name_s&quot;, legend.show=FALSE) + 
  tm_graticules() +
  tm_layout(main.title=&quot;U/N Reef (20-299) &quot;, main.title.position = &quot;center&quot;, main.title.size = 1) + 
  tmap_options(max.categories = 57) 

b &lt;- tm_shape(gbr_shape  |&gt; filter(grepl(&quot;20-299&quot;, id))) +
  tm_polygons(&quot;aquamarine4&quot;, alpha=0.2) +
  tm_layout(main.title=&quot;U/N Reef (20-299) merged&quot;, main.title.position = &quot;center&quot;, main.title.size = 1) + 
   tm_graticules()

tmap_arrange(a,b, ncol=2)</code></pre>
<p><img src="methods_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
</div>
<div id="ii-noaa-crw-dhw-data" class="section level4">
<h4>ii) NOAA CRW DHW data</h4>
<p>The NOAA Coral Reef Watch (CRW) daily global 5km satellite coral
bleaching Degree Heating Week (DHW) is a metric that shows accumulated
heat stress.</p>
<p><em>“There is a risk of coral bleaching when the DHW value reaches 4
°C-weeks. By the time the DHW value reaches 8 °C-weeks, reef-wide coral
bleaching with mortality of heat-sensitive corals is likely. If the
accumulated heat stress continues to build further and exceeds a DHW
value of 12 °C-weeks, multi-species mortality becomes likely”</em></p>
<p>The data is available from 01/04/1984 to present day (with a ~2 day
lag for processing). Data was extracted for cells within the GBR
boundaries as determined by the boundary box (plus a 1km buffer) from
the GBR shape file above. DHW were extracted for all 38 years
(1985-2023) between 1st January to 1st July, on the assumption that the
maximum heatstress would have passed by Austral winter (01/07) in each
year. For each gridcell in each year the maximum DHW value was extracted
to compare the DHW among years. DHW for 2024 were extracted seperately
due to an incomplete timeseries at the time of analysis:</p>
<p><em>Note: each year of data is ~480mb in size, so total download size
is ~15gb and may take some time</em></p>
<pre class="r"><code>gbr_shape_bbox &lt;- gbr_shape |&gt; st_transform(4326) |&gt; st_bbox()
gbr_shape_bbox &lt;- gbr_shape |&gt; st_transform(4326) |&gt; st_bbox() |&gt; st_as_sfc() |&gt; st_buffer(1) |&gt; st_bbox()

# custom function for DHW conversion to spatraster 
# (there are better functions to download erdapp data but this works)
get_dhw_gbr &lt;- function(timestart, timeend, timeout=60, crs=&quot;EPSG:20353&quot;){
  gbr_dhw_url &lt;- paste0(
    &quot;https://coastwatch.pfeg.noaa.gov/erddap/griddap/NOAA_DHW.csv?&quot;, &quot;CRW_DHW&quot;, &quot;%5B(&quot;, timestart,
    &quot;T12:00:00Z):1:(&quot;, timeend, &quot;T12:00:00Z)%5D%5B(&quot;,
   -24.86075, &quot;):1:(&quot;, -10.27304, &quot;)%5D%5B(&quot;,
   141.9369 , &quot;):1:(&quot;, 153.2032 ,
    &quot;)%5D&quot;
  )
  temp_file &lt;- tempfile(fileext = &quot;.csv&quot;)
  GET(url = gbr_dhw_url, write_disk(temp_file, overwrite = TRUE), timeout(timeout))
  csvdata &lt;- read.csv(temp_file, header = TRUE, skip=1)
  write_csv(csvdata, paste0(&quot;dhw_&quot;, start_date, &quot;_raw.csv&quot;)) 
  print(paste0(&quot;Downloading &quot;, start_date, &quot; - &quot;, end_date))
  csvdata &lt;- csvdata |&gt;
    dplyr::select(2,3,4) |&gt;
    dplyr::group_by(degrees_east, degrees_north) |&gt;
    summarise(dhw = max(Celsius.weeks)) 
  gbr_dhw &lt;- tidyterra::as_spatraster(csvdata, crs=&quot;EPSG:4326&quot;) |&gt; project(&quot;EPSG:20353&quot;)
  return(gbr_dhw)
}

# Loop the function across years from 1981 to 2023

gbr_dhw_data &lt;- list()

for(year in 1985:2023) {

  start_date &lt;- paste0(year, &quot;-01-01&quot;) # Define start and end dates for the given year
  end_date &lt;- paste0(year, &quot;-07-01&quot;)
  dhw_data &lt;- tryCatch({  # Fetch the DHW data for the GBR
    get_dhw_gbr(start_date, end_date, timeout=500)
  }, error = function(e) { #Use tryCatch to handle  errors or timeouts
    message(paste(&quot;Error fetching data for year&quot;, year, &quot;:&quot;, e$message))
    NULL # Return NULL if there was an error
  })

  gbr_dhw_data[[as.character(year)]] &lt;- dhw_data #Store the list using the year as the name
  
}

# Ammend 2024 data

for(year in 2024) {

  start_date &lt;- paste0(year, &quot;-01-01&quot;) # Define start and end dates for the given year
  end_date &lt;- paste0(year, &quot;-07-01&quot;)
  dhw_data &lt;- tryCatch({  # Fetch the DHW data for the GBR
    get_dhw_gbr(start_date, end_date, timeout=500)
  }, error = function(e) { #Use tryCatch to handle  errors or timeouts
    message(paste(&quot;Error fetching data for year&quot;, year, &quot;:&quot;, e$message))
    NULL # Return NULL if there was an error
  })

  gbr_dhw_data[[as.character(year)]] &lt;- dhw_data #Store the list using the year as the name
  
}


# function borrowed from FAMEFMR::saveSpatRasterList:
gbr_dhw_data_list&lt;-rapply(gbr_dhw_data_list,f=terra::wrap, classes = &quot;SpatRaster&quot;,how=&quot;replace&quot;)
qs::qsave(gbr_dhw_data_list,&quot;gbr_dhw_data.RData&quot;)</code></pre>
</div>
<div id="iii-spatial-stats" class="section level4">
<h4>iii) Spatial stats</h4>
<p>As DHW is automatically calculated each day in the NOAA dataset, the
years in max DHW refer to the year of bleaching (e.g. 2016 = cumulative
heatstress from the end of 2015 and the start of 2016). For each reef
multipolygon in the <code>gbr_shape</code> dataset, the maximum DHW in
each year was calculated using an area-weighted approach due to
(<code>exactextractr::exact_extract</code> was used over
<code>stars::st_extract</code> | <code>vect::extract</code> |
<code>raster::extract</code> due to <a
href="https://gis.stackexchange.com/questions/393763/extract-in-r-raster-package-incredibly-slow">performance
issues</a>]).</p>
<p>The <code>exact_extract</code> approach used below is conservative in
that for larger reef polygons (or multipolyons), it calculates the
<code>mean</code> value of cells that intersect the polygon weighted by
the fraction of the cell that is covered (as opposed to the
<code>max</code> value). Other metrics such as <code>variance</code> and
<code>coefficient_of_variation</code> may be of interest. Undefined (NA)
values are ignored in all of the named summary operations when they
occur in the value raster. When they occur in the weighting raster, they
cause the result of the summary operation to be NA.</p>
<pre class="r"><code>library(reactable)

gbr_shape_dhw_list &lt;- qs::qread(&quot;/Users/rof011/GBR-coral-bleaching/data/gbr_dhw_data.RData&quot;)
gbr_shape_dhw_list &lt;- lapply(gbr_shape_dhw_list, function(x) terra::unwrap(x))
gbr_shape_dhw_list &lt;- terra::rast(gbr_shape_dhw_list)
names(gbr_shape_dhw_list) &lt;- paste0(&quot;year_&quot;, seq(1986,2024,1))

year_list &lt;- paste0(&quot;year_&quot;, seq(1986,2024,1))
gbr_shape_dhw &lt;- gbr_shape

for (i in year_list) {
  year_col_name &lt;- paste(&quot;dhw_max&quot;, sub(&quot;^.*_&quot;, &quot;&quot;, i), sep=&quot;_&quot;)
  gbr_shape_dhw[[year_col_name]] &lt;- exact_extract(gbr_shape_dhw_list[[i]], progress = FALSE,
                                                  gbr_shape_dhw, fun = &quot;mean&quot;, weights = &quot;area&quot;)
}


head(gbr_shape_dhw) |&gt; 
  kable(&quot;html&quot;) |&gt;  
  kable_styling(&quot;striped&quot;, font_size=11) |&gt;  
  scroll_box(width = &quot;100%&quot;)</code></pre>
<div
style="border: 1px solid #ddd; padding: 5px; overflow-x: scroll; width:100%; ">
<table class="table table-striped" style="font-size: 11px; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
gbr_name
</th>
<th style="text-align:left;">
id
</th>
<th style="text-align:left;">
geometry
</th>
<th style="text-align:right;">
dhw_max_1986
</th>
<th style="text-align:right;">
dhw_max_1987
</th>
<th style="text-align:right;">
dhw_max_1988
</th>
<th style="text-align:right;">
dhw_max_1989
</th>
<th style="text-align:right;">
dhw_max_1990
</th>
<th style="text-align:right;">
dhw_max_1991
</th>
<th style="text-align:right;">
dhw_max_1992
</th>
<th style="text-align:right;">
dhw_max_1993
</th>
<th style="text-align:right;">
dhw_max_1994
</th>
<th style="text-align:right;">
dhw_max_1995
</th>
<th style="text-align:right;">
dhw_max_1996
</th>
<th style="text-align:right;">
dhw_max_1997
</th>
<th style="text-align:right;">
dhw_max_1998
</th>
<th style="text-align:right;">
dhw_max_1999
</th>
<th style="text-align:right;">
dhw_max_2000
</th>
<th style="text-align:right;">
dhw_max_2001
</th>
<th style="text-align:right;">
dhw_max_2002
</th>
<th style="text-align:right;">
dhw_max_2003
</th>
<th style="text-align:right;">
dhw_max_2004
</th>
<th style="text-align:right;">
dhw_max_2005
</th>
<th style="text-align:right;">
dhw_max_2006
</th>
<th style="text-align:right;">
dhw_max_2007
</th>
<th style="text-align:right;">
dhw_max_2008
</th>
<th style="text-align:right;">
dhw_max_2009
</th>
<th style="text-align:right;">
dhw_max_2010
</th>
<th style="text-align:right;">
dhw_max_2011
</th>
<th style="text-align:right;">
dhw_max_2012
</th>
<th style="text-align:right;">
dhw_max_2013
</th>
<th style="text-align:right;">
dhw_max_2014
</th>
<th style="text-align:right;">
dhw_max_2015
</th>
<th style="text-align:right;">
dhw_max_2016
</th>
<th style="text-align:right;">
dhw_max_2017
</th>
<th style="text-align:right;">
dhw_max_2018
</th>
<th style="text-align:right;">
dhw_max_2019
</th>
<th style="text-align:right;">
dhw_max_2020
</th>
<th style="text-align:right;">
dhw_max_2021
</th>
<th style="text-align:right;">
dhw_max_2022
</th>
<th style="text-align:right;">
dhw_max_2023
</th>
<th style="text-align:right;">
dhw_max_2024
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
(Big) Broadhurst Reef (No 1)
</td>
<td style="text-align:left;">
18-100
</td>
<td style="text-align:left;">
POLYGON ((1848551 7867941, …
</td>
<td style="text-align:right;">
0.4779795
</td>
<td style="text-align:right;">
6.827402
</td>
<td style="text-align:right;">
0.000000
</td>
<td style="text-align:right;">
0.1597545
</td>
<td style="text-align:right;">
0.7435788
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0.000000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.7756083
</td>
<td style="text-align:right;">
1.6970549
</td>
<td style="text-align:right;">
0.4418001
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.3921288
</td>
<td style="text-align:right;">
0.4099048
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.6378967
</td>
<td style="text-align:right;">
2.2812221
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2.099609
</td>
<td style="text-align:right;">
0.6406564
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0.0086903
</td>
<td style="text-align:right;">
0.6626197
</td>
<td style="text-align:right;">
0.2797973
</td>
<td style="text-align:right;">
0.8909236
</td>
<td style="text-align:right;">
0.9841175
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.9966893
</td>
<td style="text-align:right;">
2.639892
</td>
<td style="text-align:right;">
3.855308
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
4.845179
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
5.318794
</td>
<td style="text-align:right;">
1.0536289
</td>
<td style="text-align:right;">
3.319114
</td>
</tr>
<tr>
<td style="text-align:left;">
(Big) Broadhurst Reef (No 2)
</td>
<td style="text-align:left;">
18-100
</td>
<td style="text-align:left;">
POLYGON ((1845249 7862813, …
</td>
<td style="text-align:right;">
0.4809034
</td>
<td style="text-align:right;">
6.690235
</td>
<td style="text-align:right;">
0.000000
</td>
<td style="text-align:right;">
0.1626551
</td>
<td style="text-align:right;">
0.7322140
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0.000000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.8063999
</td>
<td style="text-align:right;">
1.7350723
</td>
<td style="text-align:right;">
0.3083107
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.2800516
</td>
<td style="text-align:right;">
0.4745746
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5255354
</td>
<td style="text-align:right;">
1.9665437
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2.207775
</td>
<td style="text-align:right;">
0.5768712
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0.0397638
</td>
<td style="text-align:right;">
0.6499974
</td>
<td style="text-align:right;">
0.5694084
</td>
<td style="text-align:right;">
0.9334313
</td>
<td style="text-align:right;">
1.0662649
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.9251226
</td>
<td style="text-align:right;">
2.608260
</td>
<td style="text-align:right;">
3.985060
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
4.911906
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
5.216156
</td>
<td style="text-align:right;">
1.0033153
</td>
<td style="text-align:right;">
3.714746
</td>
</tr>
<tr>
<td style="text-align:left;">
(Big) Stevens Reef
</td>
<td style="text-align:left;">
20-295
</td>
<td style="text-align:left;">
POLYGON ((2094621 7653332, …
</td>
<td style="text-align:right;">
2.2126808
</td>
<td style="text-align:right;">
7.462231
</td>
<td style="text-align:right;">
0.000000
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0.6870964
</td>
<td style="text-align:right;">
0.3540293
</td>
<td style="text-align:right;">
1.372475
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0930394
</td>
<td style="text-align:right;">
1.1178683
</td>
<td style="text-align:right;">
0.0926058
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.7353671
</td>
<td style="text-align:right;">
0.1865064
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0013572
</td>
<td style="text-align:right;">
7.0890689
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
4.832458
</td>
<td style="text-align:right;">
0.2291969
</td>
<td style="text-align:right;">
1.4887915
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.6001107
</td>
<td style="text-align:right;">
0.8347213
</td>
<td style="text-align:right;">
2.2275841
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0.7364363
</td>
<td style="text-align:right;">
0.6408299
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.2891974
</td>
<td style="text-align:right;">
1.597199
</td>
<td style="text-align:right;">
4.002799
</td>
<td style="text-align:right;">
0.0894790
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
8.630629
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
5.692474
</td>
<td style="text-align:right;">
0.8342787
</td>
<td style="text-align:right;">
8.230654
</td>
</tr>
<tr>
<td style="text-align:left;">
(Little) Broadhurst Reef
</td>
<td style="text-align:left;">
18-106
</td>
<td style="text-align:left;">
POLYGON ((1846710 7851185, …
</td>
<td style="text-align:right;">
0.4927949
</td>
<td style="text-align:right;">
7.060939
</td>
<td style="text-align:right;">
0.000000
</td>
<td style="text-align:right;">
0.1851825
</td>
<td style="text-align:right;">
0.7358017
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0.000000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.7554580
</td>
<td style="text-align:right;">
1.9170403
</td>
<td style="text-align:right;">
0.6352469
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.0039911
</td>
<td style="text-align:right;">
0.5008817
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.5964878
</td>
<td style="text-align:right;">
2.9083798
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2.061579
</td>
<td style="text-align:right;">
1.0029445
</td>
<td style="text-align:right;">
0.0133093
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0.7555013
</td>
<td style="text-align:right;">
0.2112552
</td>
<td style="text-align:right;">
0.8949642
</td>
<td style="text-align:right;">
1.1583098
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2.1319892
</td>
<td style="text-align:right;">
2.261860
</td>
<td style="text-align:right;">
4.152460
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
4.817797
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
5.554096
</td>
<td style="text-align:right;">
1.2604388
</td>
<td style="text-align:right;">
3.465622
</td>
</tr>
<tr>
<td style="text-align:left;">
(Little) Stevens Reef
</td>
<td style="text-align:left;">
20-294
</td>
<td style="text-align:left;">
POLYGON ((2085467 7656254, …
</td>
<td style="text-align:right;">
2.1869435
</td>
<td style="text-align:right;">
7.334218
</td>
<td style="text-align:right;">
0.000000
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0.7461356
</td>
<td style="text-align:right;">
0.6261856
</td>
<td style="text-align:right;">
1.198692
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0085639
</td>
<td style="text-align:right;">
0.9957811
</td>
<td style="text-align:right;">
0.1803312
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.9897678
</td>
<td style="text-align:right;">
0.2502062
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
6.7362270
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
4.782020
</td>
<td style="text-align:right;">
0.3121046
</td>
<td style="text-align:right;">
1.6231992
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.4489488
</td>
<td style="text-align:right;">
0.9118187
</td>
<td style="text-align:right;">
2.2421041
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0.8632997
</td>
<td style="text-align:right;">
0.6447247
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.2262332
</td>
<td style="text-align:right;">
1.900885
</td>
<td style="text-align:right;">
3.752129
</td>
<td style="text-align:right;">
0.1179417
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
9.029800
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
6.001618
</td>
<td style="text-align:right;">
1.0063132
</td>
<td style="text-align:right;">
8.097749
</td>
</tr>
<tr>
<td style="text-align:left;">
Abott Reef
</td>
<td style="text-align:left;">
19-222
</td>
<td style="text-align:left;">
POLYGON ((2119752 7720364, …
</td>
<td style="text-align:right;">
0.7593529
</td>
<td style="text-align:right;">
5.319762
</td>
<td style="text-align:right;">
0.594146
</td>
<td style="text-align:right;">
0.1600000
</td>
<td style="text-align:right;">
0.3113776
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0.000000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.1686566
</td>
<td style="text-align:right;">
0.7345553
</td>
<td style="text-align:right;">
0.1500000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.1293507
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.1302553
</td>
<td style="text-align:right;">
0.9077468
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
3.292808
</td>
<td style="text-align:right;">
0.1700677
</td>
<td style="text-align:right;">
0.4479577
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.3000000
</td>
<td style="text-align:right;">
2.9156933
</td>
<td style="text-align:right;">
0.7369853
</td>
<td style="text-align:right;">
0.4514952
</td>
<td style="text-align:right;">
0.4714453
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.4719019
</td>
<td style="text-align:right;">
2.083957
</td>
<td style="text-align:right;">
2.504015
</td>
<td style="text-align:right;">
0.0000000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
4.460752
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
4.484212
</td>
<td style="text-align:right;">
0.6828330
</td>
<td style="text-align:right;">
9.708863
</td>
</tr>
</tbody>
</table>
</div>
<pre class="r"><code>saveRDS(gbr_shape_dhw, &quot;/Users/rof011/GBR-coral-bleaching/data/gbr_shape_dhw.RDS&quot;)</code></pre>
<p>The output is an <code>sfc</code> of polygons for each reef with max
DHW for each year from 1984:2016 (see below example of the max DHW
experienced at Heron Island vs Lizard Island in 2016).</p>
</div>
<div id="individual-reef-timeseries" class="section level3">
<h3>1) Individual reef timeseries</h3>
<p>The DHW dataset can be filtered to quantify the trajectories of
individual reefs through time (for example Heron Island in the southern
GBR and Lizard Island in the northern GBR):</p>
<pre class="r"><code>tmap_mode(&quot;plot&quot;)

a &lt;- tm_shape(gbr_shape_dhw |&gt; filter(grepl(&quot;Lizard&quot;, gbr_name)) |&gt; mutate(dhw_max_2016=as.numeric(dhw_max_2016)) ) + 
  tm_polygons(col=&quot;dhw_max_2016&quot;, palette=&quot;-RdBu&quot;, breaks= seq(1:10), alpha=0.8, legend.show=FALSE) + 
  tm_layout(main.title=&quot;Lizard Island (2016)&quot;, main.title.position = &quot;center&quot;, main.title.size = 1) +
  tm_graticules(lwd=0.2)


b &lt;- tm_shape(gbr_shape_dhw |&gt; filter(gbr_name==&quot;Heron Reef&quot;) |&gt; mutate(dhw_max_2016=as.numeric(dhw_max_2016))) + 
  tm_polygons(col=&quot;dhw_max_2016&quot;, palette=&quot;-RdBu&quot;, breaks= seq(1:10), alpha=0.8) +
  tm_layout(main.title=&quot;Heron Reef (2016)&quot;, main.title.position = &quot;center&quot;, main.title.size = 1) + 
  tm_graticules(lwd=0.2)

tmap_arrange(b,a, ncol=2)</code></pre>
<p><img src="methods_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>As the dataset is in <code>sf</code> format, the output for each year
can be plotted spatially to compare the maximum DHW for adjacent reefs,
for example Heron Reef and Lizard Reef (Lizard Reef is composed of
multiple polygons based on label_ID) where the within-reef trajectories
are fit with a simple GAM model:</p>
<pre class="r"><code>dhw_subset &lt;- gbr_shape_dhw |&gt; 
  filter(gbr_name==&quot;Lizard Island Reef (North East)&quot; | gbr_name==&quot;Heron Reef&quot;) |&gt;
  as.data.frame() |&gt; 
  dplyr::select(-id, -geometry) |&gt; 
  pivot_longer(-gbr_name, names_to=&quot;year&quot;, values_to=&quot;dhw&quot;) |&gt; 
  mutate(year = as.numeric(str_extract_all(year, &quot;\\d+&quot;))) |&gt; 
  arrange(gbr_name, year) 

ggplot() + theme_bw() + facet_wrap(~gbr_name, ncol=2) +
  geom_smooth(data=dhw_subset, aes(x=year, y=dhw, color=gbr_name), 
              method = &quot;gam&quot;, formula = y ~ s(x, bs = &quot;cr&quot;, k = 10), show.legend = FALSE) +
  geom_line(data=dhw_subset, aes(x=year, y=dhw, color=gbr_name), show.legend=FALSE) +
  geom_point(data=dhw_subset, aes(year, dhw, fill=gbr_name), shape=21, size=2, show.legend=FALSE) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  scale_fill_manual(values=c(&quot;aquamarine2&quot;, &quot;coral2&quot;)) +
  scale_color_manual(values=c(&quot;aquamarine4&quot;, &quot;coral4&quot;))</code></pre>
<p><img src="methods_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>
<div id="gbr-wide-timeseries" class="section level3">
<h3>2) GBR-wide timeseries</h3>
<p>The dataset can be used to determine how the landscape has changed
across multiple mass coral bleaching events since 1985 in terms of
increasing frequency and intensity of heatwaves. The below example is
the output of individual GAM model fits for 3724 reef polygons
(label_ID) from 1985-2024.</p>
<pre class="r"><code># https://zenodo.org/records/5146061/preview/ymbozec/REEFMOD.6.4_GBR_HINDCAST_ANALYSES-v1.0.0.zip

# make a new zones for whole id
id_zones &lt;- read.csv(&quot;/Users/rof011/GBR-coral-bleaching/data/gbr_zones.csv&quot;) |&gt;
  mutate(id=str_replace(label_id, &quot;[a-zA-Z]$&quot;, &quot;&quot;)) |&gt;
  dplyr::select(-label_id, -X) |&gt;
  distinct()

gbr_shape_dhw_centroid &lt;- gbr_shape_dhw |&gt;
  st_centroid() |&gt;
  st_coordinates() |&gt;
  as.data.frame() |&gt;
  rename(lon=1, lat=2)

gbr_shape_dhw_zones_long &lt;- gbr_shape_dhw %&gt;%
  as.data.frame() %&gt;%
  dplyr::select(-geometry) %&gt;%
  cbind(., gbr_shape_dhw_centroid) %&gt;%
  pivot_longer(cols = starts_with(&quot;dhw_max_&quot;), names_to = &quot;year&quot;, values_to = &quot;dhw_max&quot;) %&gt;%
  mutate(year = str_replace(year, &quot;dhw_max_&quot;, &quot;&quot;)) %&gt;%
  left_join(id_zones, by=&quot;id&quot;)


ggplot() + theme_bw() + 
  geom_smooth(data=gbr_shape_dhw_zones_long |&gt; na.omit() |&gt; droplevels(), 
              aes(x=year, y=dhw_max, group=gbr_name), 
              color=&quot;darkgrey&quot;, se = FALSE, linewidth=0.05, method = &quot;gam&quot;, 
              formula = y ~ s(x, bs = &quot;cr&quot;, k = 10), show.legend = FALSE) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) </code></pre>
<p><img src="methods_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>Similarly, the data can be used to compare the impact of the current
event (2024) with the previous mass bleaching events on the GBR (1998,
2002, 2012, 2016, 2017, 2020, 2022) in terms of maximum DHW experienced
per event:</p>
<pre class="r"><code>dhw_subset_bleaching_dhw &lt;- gbr_shape_dhw |&gt; 
  as.data.frame() |&gt; 
  dplyr::select(-id, -geometry) |&gt; 
  pivot_longer(-gbr_name, names_to=&quot;year&quot;, values_to=&quot;dhw_max&quot;) |&gt; 
  mutate(year = as.numeric(str_extract_all(year, &quot;\\d+&quot;))) |&gt; 
  arrange(gbr_name, year) |&gt; 
  filter(year %in% c(1998,2002,2016,2017,2020,2022,2024)) |&gt; 
  group_by(year) |&gt; 
  mutate(mean_dhw_max = mean(dhw_max, na.rm=TRUE))


a &lt;- ggplot() + theme_bw() + 
  ggridges::stat_density_ridges(data=dhw_subset_bleaching_dhw, alpha=0.8, scale=1.2, size=0.3,
                                aes(y=as.factor(year), x=dhw_max, fill=mean_dhw_max), rel_min_height=0.00001,
                                quantiles = c(0.5),  quantile_lines = FALSE, quantile_fun = mean,
                                vline_color = c(&quot;white&quot;), vline_width = 2, show.legend=FALSE) +
  scale_fill_distiller(palette = &quot;Reds&quot;, direction = 1, name=&quot;mean\nmax_DHW\nper reef&quot;) +
  xlab(&quot;Maximum DHW per reef&quot;) + ylab(&quot;Mass bleaching event&quot;) +
   theme(panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank())


a</code></pre>
<p><img src="methods_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<pre class="r"><code># b &lt;- ggplot() + theme_bw() + 
#   ggridges::stat_density_ridges(data=dhw_subset_bleaching_dhw, alpha=0.8, scale=0.8, size=0.3, 
#                                 rel_min_height=0.001,
#                                 aes(y=as.factor(year), x=dhw_max, fill=mean_dhw_max),show.legend=TRUE) +
#   scale_fill_distiller(palette = &quot;Reds&quot;, direction = 1, name=&quot;mean\nmax_DHW\nper reef&quot;) +
#   xlab(&quot;Maximum DHW per reef&quot;) + ylab(&quot;&quot;) + scale_x_continuous(limits=c(0,8), oob = scales::oob_squish) +
#    theme(panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank())
# 
# a+b+ patchwork::plot_layout(widths = c(0.7,0.3))</code></pre>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = false;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
